<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NemeSync Stock</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Papa Parse for CSV handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Chart.js for creating charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS (XLSX) for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Custom styles for better UX */
        body, html {
            height: 100%;
            overflow-x: hidden;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* bg-slate-100 */
        }
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        .modal .transform {
            transition: transform 0.3s ease-in-out;
        }
        .tab {
            transition: all 0.2s ease;
        }
        .tab-active {
            border-bottom-color: #4f46e5; /* indigo-600 */
            color: #4f46e5;
            font-weight: 600;
        }
        #login-screen, #landing-screen {
             min-height: 100vh;
             width: 100vw;
        }
        /* Sync/Logout Button Animation */
        #logoutBtn i, #syncDataBtn i {
            transition: transform 0.4s ease-in-out, color 0.4s ease-in-out;
        }
        #syncDataBtn.syncing i {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        [data-table-search]::-webkit-search-cancel-button {
            display: none;
        }
        .option-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .option-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }
        /* Animated Gradient Background */
        .animated-gradient {
            background: linear-gradient(-45deg, #8b5cf6, #f97316, #ec4899, #14b8a6);
            background-size: 400% 400%;
            animation: gradient-wave 15s ease infinite;
        }
        @keyframes gradient-wave {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
       .icon-wrapper {
            width: 80px;
            height: 70px;
            margin: 0 auto 1.5rem auto;
            display: flex;
            align-items: center;
            justify-content: center;
       }

        /* Anubis Scales Animation */
        .anubis-scales-wrapper {
             animation: scales-tilt 3s ease-in-out infinite;
             transform-origin: 50% 60%;
        }
        @keyframes scales-tilt {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
        }

        /* Horus Eye Pulse Animation */
        .horus-eye-wrapper {
            animation: pulse-eye 2.5s infinite;
        }
        @keyframes pulse-eye {
            0%, 100% {
                transform: scale(1);
                filter: drop-shadow(0 0 0 #fff);
            }
            50% {
                transform: scale(1.1);
                filter: drop-shadow(0 0 8px #fff) drop-shadow(0 0 15px #8b5cf6);
            }
        }

        /* Muse IA (Medusa) Icon Animation */
         .muse-icon-wrapper .snake {
            transform-origin: 50% 50%;
            animation: snake-sway 3s infinite ease-in-out;
        }
        .muse-icon-wrapper .snake:nth-child(even) {
            animation-duration: 2.5s;
            animation-delay: 0.2s;
        }
         .muse-icon-wrapper .snake:nth-child(3n) {
            animation-duration: 3.5s;
            animation-delay: 0.5s;
        }
        @keyframes snake-sway {
            0%, 100% { transform: rotate(0deg) translateX(0); }
            50% { transform: rotate(5deg) translateX(5px); }
        }


        /* Odisea IA Custom Animation */
        .greek-ship {
            animation: ship-rock 4s ease-in-out infinite;
            transform-origin: bottom center;
        }
        .wave {
            stroke-dasharray: 100;
            stroke-dashoffset: 0;
            animation: wave-flow 4s linear infinite;
        }
        @keyframes ship-rock {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(-8deg); }
        }
        @keyframes wave-flow {
            from { stroke-dashoffset: 200; }
            to { stroke-dashoffset: 0; }
        }

    </style>
</head>
<body class="bg-slate-100">

    <!-- Landing Screen -->
    <div id="landing-screen" class="animated-gradient relative flex flex-col p-4">
        <div class="flex-grow flex flex-col items-center justify-center py-8">
            <div class="text-center mb-12">
                <h1 class="text-5xl md:text-6xl font-bold text-white mb-4 tracking-tight">Bienvenido a JGM Apps</h1>
                <p class="text-indigo-200 text-lg">Seleccione la aplicación que desea utilizar</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Inventory App Card -->
                <div id="goToInventoryBtn" class="option-card cursor-pointer bg-white/10 backdrop-blur-lg rounded-xl shadow-2xl p-8 w-80 text-center">
                    <div class="icon-wrapper anubis-scales-wrapper">
                         <svg viewBox="0 0 100 100" fill="none" stroke="white" stroke-width="5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M10 30 H 90"/>
                            <path d="M50 30 V 10"/>
                             <path d="M50 85 V 90"/>
                            <path d="M30 85 H 70"/>
                            <g>
                                <path d="M25 30 V 45" />
                                <path d="M15 45 A 10 10 0 0 0 35 45 Z" fill="white"/>
                            </g>
                            <g>
                                <path d="M75 30 V 45" />
                                <path d="M65 45 A 10 10 0 0 0 85 45 Z" fill="white"/>
                            </g>
                         </svg>
                    </div>
                    <h2 class="text-3xl font-bold text-white">NemeSync Stock</h2>
                    <p class="text-indigo-200 text-md mt-2">Control de Inventario</p>
                </div>
                <!-- Appointments App Card -->
                <div id="goToAppointmentsBtn" class="option-card cursor-pointer bg-white/10 backdrop-blur-lg rounded-xl shadow-2xl p-8 w-80 text-center">
                     <div class="icon-wrapper horus-eye-wrapper">
                         <svg viewBox="0 0 100 70" stroke="white" stroke-width="4" fill="none" stroke-linecap="round" stroke-linejoin="round">
                           <g transform="translate(0, 5)">
                             <path d="M5,30 C20,5 80,5 95,30 C80,55 20,55 5,30 Z" />
                             <circle cx="50" cy="30" r="12" fill="white"/>
                             <path d="M50,30 L70,55 L75,60"/>
                             <path d="M45,15 Q50,20 55,15"/>
                           </g>
                        </svg>
                    </div>
                    <h2 class="text-3xl font-bold text-white">Horus Date</h2>
                    <p class="text-indigo-200 text-md mt-2">El Ojo que todo lo Agenda</p>
                </div>
                <!-- Muse IA Card -->
                 <div id="goToMuseIABtn" class="option-card cursor-pointer bg-white/10 backdrop-blur-lg rounded-xl shadow-2xl p-8 w-80 text-center">
                    <div class="icon-wrapper muse-icon-wrapper">
                        <svg viewBox="0 0 100 100" fill="white" stroke-linecap="round" stroke-linejoin="round">
                             <g transform="scale(1.2) translate(-8, -10)">
                                <path d="M49.5,75.5 C49.5,75.5 45.5,85.5 49.5,90.5 C53.5,85.5 49.5,75.5 49.5,75.5 M49.5,58.5 C49.5,58.5 41.5,58.5 41.5,66.5 C41.5,74.5 57.5,74.5 57.5,66.5 C57.5,58.5 49.5,58.5 49.5,58.5 " stroke="white" stroke-width="2.5" fill="none" />
                                <path class="snake" d="M34.5,46.5 C19.5,41.5 28.5,19.5 40.5,19.5 C52.5,19.5 48.5,35.5 46.5,41.5 " stroke="white" stroke-width="3" fill="none"/>
                                <path class="snake" d="M64.5,46.5 C79.5,41.5 70.5,19.5 58.5,19.5 C46.5,19.5 50.5,35.5 52.5,41.5 " stroke="white" stroke-width="3" fill="none"/>
                                <path class="snake" d="M29.5,58.5 C14.5,53.5 14.5,30.5 28.5,27.5 C42.5,24.5 41.5,44.5 41.5,52.5 " stroke="white" stroke-width="3" fill="none"/>
                                <path class="snake" d="M69.5,58.5 C84.5,53.5 84.5,30.5 70.5,27.5 C56.5,24.5 57.5,44.5 57.5,52.5 " stroke="white" stroke-width="3" fill="none"/>
                                <path class="snake" d="M49.5,58.5 C49.5,58.5 49.5,10.5 41.5,5.5 C33.5,0.5 24.5,12.5 32.5,24.5 " stroke="white" stroke-width="3" fill="none"/>
                                <path class="snake" d="M49.5,58.5 C49.5,58.5 49.5,10.5 57.5,5.5 C65.5,0.5 74.5,12.5 66.5,24.5 " stroke="white" stroke-width="3" fill="none"/>
                                <path class="snake" d="M22.5,67.5 C2.5,67.5 10.5,46.5 25.5,44.5 C40.5,42.5 38.5,59.5 36.5,64.5 " stroke="white" stroke-width="3" fill="none"/>
                                <path class="snake" d="M76.5,67.5 C96.5,67.5 88.5,46.5 73.5,44.5 C58.5,42.5 60.5,59.5 62.5,64.5 " stroke="white" stroke-width="3" fill="none"/>
                                <path class="snake" d="M49.5,58.5 C34.5,53.5 29.5,41.5 29.5,41.5 " stroke="white" stroke-width="3" fill="none"/>
                            </g>
                        </svg>
                    </div>
                    <h2 class="text-3xl font-bold text-white">Muse IA</h2>
                    <p class="text-indigo-200 text-md mt-2">Inspiracion de las 9 Musas</p>
                </div>
                 <!-- Odisea IA Card -->
                <div id="goToOdiseaIABtn" class="option-card cursor-pointer bg-white/10 backdrop-blur-lg rounded-xl shadow-2xl p-8 w-80 text-center">
                     <div class="icon-wrapper">
                        <svg class="greek-ship" viewBox="0 0 100 80">
                           <g transform="scale(1.2) translate(-10, -10)">
                            <path d="M 20 60 L 80 60 L 75 40 L 25 40 Z" fill="white" stroke="white" stroke-width="2" />
                             <path d="M 20 60 C 10 60 10 40 20 40" stroke="white" stroke-width="2" fill="none" />
                             <path d="M 80 60 C 90 60 90 40 80 40" stroke="white" stroke-width="2" fill="none" />
                            <rect x="48" y="10" width="4" height="30" fill="white" />
                            <path d="M 50 15 L 75 25 L 50 35 Z" fill="white" />
                            <path class="wave" d="M -10 70 Q 15 60, 40 70 T 90 70 T 140 70" stroke="white" stroke-width="4" fill="none" />
                           </g>
                        </svg>
                    </div>
                    <h2 class="text-3xl font-bold text-white">Odisea IA</h2>
                    <p class="text-indigo-200 text-md mt-2">Viaja y Crea Sin Limites</p>
                </div>
            </div>
        </div>
         <footer class="w-full text-center p-4 text-white text-sm shrink-0">
            JGM Studios © 2025. Todos los derechos reservados.
        </footer>
    </div>


    <!-- Login Screen -->
    <div id="login-screen" class="hidden relative items-center justify-center animated-gradient p-4">
        <div class="w-full max-w-sm mx-auto">
            <button id="backToLandingBtn" class="absolute top-5 left-5 text-white bg-white/20 rounded-full w-10 h-10 flex items-center justify-center hover:bg-white/30 transition">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="bg-white/10 backdrop-blur-lg rounded-xl shadow-2xl p-8">
                <div class="text-center mb-8">
                    <i class="fas fa-boxes-stacked fa-3x text-white mb-4"></i>
                    <h1 class="text-3xl font-bold text-white">NemeSync Stock</h1>
                    <p class="text-indigo-200">Por favor, inicie sesión</p>
                </div>
                <form id="loginForm">
                    <div class="mb-4">
                        <label for="email" class="sr-only">Email</label>
                        <div class="relative">
                            <input id="email" type="email" class="w-full bg-white/20 text-white placeholder-indigo-200 border border-white/30 rounded-lg py-3 px-4 pl-12 focus:outline-none focus:ring-2 focus:ring-white/50" placeholder="Email" required>
                             <i class="fas fa-envelope absolute left-4 top-1/2 -translate-y-1/2 text-indigo-200"></i>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="sr-only">Contraseña</label>
                        <div class="relative">
                             <input id="password" type="password" class="w-full bg-white/20 text-white placeholder-indigo-200 border border-white/30 rounded-lg py-3 px-4 pl-12 pr-12 focus:outline-none focus:ring-2 focus:ring-white/50" placeholder="Contraseña" required>
                             <i class="fas fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-indigo-200"></i>
                             <button type="button" id="togglePassword" class="absolute right-4 top-1/2 -translate-y-1/2 text-indigo-200 hover:text-white">
                                <i class="fas fa-eye"></i>
                             </button>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-white text-indigo-600 font-bold py-3 px-4 rounded-lg hover:bg-indigo-100 transition-colors duration-300 shadow-lg">Ingresar</button>
                    <p id="loginError" class="text-red-300 text-center mt-4 text-sm font-semibold hidden"></p>
                </form>
                <div class="text-center mt-6">
                    <button id="showCreateUserModalBtn" class="text-indigo-200 hover:text-white text-sm">Crear nuevo usuario</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Main App Container -->
    <div id="app" class="p-4 md:p-8 max-w-7xl mx-auto hidden">
        <!-- Main Header -->
        <header class="bg-white p-6 rounded-xl shadow-md mb-6">
            <div class="flex flex-col-reverse sm:flex-row justify-between items-start gap-4">
                 <div class="text-left">
                    <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-600 via-purple-600 to-orange-500 bg-clip-text text-transparent">NemeSync Stock</h1>
                    <p class="text-sm text-slate-500 mt-1">Gestione sus productos, entradas y salidas de forma eficiente.</p>
                </div>
                <div class="flex flex-wrap items-center gap-2 w-full sm:w-auto justify-start sm:justify-end">
                     <button id="syncDataBtn" title="Estado de Sincronización" class="bg-purple-600 text-white font-bold p-2 px-3 rounded-lg disabled:opacity-50">
                        <i class="fas fa-sync-alt fa-lg"></i>
                    </button>
                    <button id="viewArchivesBtn" title="Ver Archivos" class="bg-slate-700 text-white font-bold p-2 px-3 rounded-lg hover:bg-slate-800 transition-colors">
                        <i class="fas fa-archive fa-lg"></i>
                    </button>
                    <button id="openEntryModalBtn" title="Registrar Entrada" class="bg-green-500 text-white font-bold p-2 px-3 rounded-lg hover:bg-green-600 transition-colors">
                        <i class="fas fa-plus-circle fa-lg"></i>
                    </button>
                    <button id="openExitModalBtn" title="Registrar Salida" class="bg-red-500 text-white font-bold p-2 px-3 rounded-lg hover:bg-red-600 transition-colors">
                        <i class="fas fa-minus-circle fa-lg"></i>
                    </button>
                    <button id="saveMonthBtn" title="Cierre Mensual" class="bg-indigo-500 text-white font-bold p-2 px-3 rounded-lg hover:bg-indigo-600 transition-colors">
                        <i class="fas fa-calendar-check fa-lg"></i>
                    </button>
                    <button id="logoutBtn" title="Cerrar Sesión" class="bg-slate-200 text-slate-600 font-bold p-2 px-3 rounded-lg hover:bg-slate-300 transition-colors">
                        <i class="fas fa-times fa-lg"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="bg-white p-6 rounded-xl shadow-md">
            <nav id="tabs" class="border-b border-slate-200 mb-6">
                <ul class="flex flex-wrap -mb-px">
                    <li><a href="#" class="tab tab-active inline-block p-4 border-b-2 border-transparent rounded-t-lg" data-tab="stock">Stock Actual</a></li>
                    <li><a href="#" class="tab inline-block p-4 border-b-2 border-transparent rounded-t-lg" data-tab="entries">Entradas</a></li>
                    <li><a href="#" class="tab inline-block p-4 border-b-2 border-transparent rounded-t-lg" data-tab="exits">Salidas</a></li>
                    <li><a href="#" class="tab inline-block p-4 border-b-2 border-transparent rounded-t-lg" data-tab="initial">Inv. Inicial</a></li>
                    <li><a href="#" class="tab inline-block p-4 border-b-2 border-transparent rounded-t-lg" data-tab="final">Inv. Final</a></li>
                    <li><a href="#" class="tab inline-block p-4 border-b-2 border-transparent rounded-t-lg" data-tab="annual_report">Reporte Anual</a></li>
                </ul>
            </nav>
            <div id="tab-content">
                <!-- Content will be rendered by JavaScript -->
                 <div class="text-center py-10 text-slate-500">
                    <i class="fas fa-spinner fa-spin fa-3x"></i>
                    <p class="mt-4">Cargando datos...</p>
                 </div>
            </div>
        </main>
        <footer class="text-center p-4 text-slate-500 text-sm mt-8">
            JGM Studios © 2025. Todos los derechos reservados.
        </footer>
    </div>

    <!-- Hidden input for file uploads -->
    <input type="file" id="upload-csv-input" class="hidden" accept=".csv">

    <!-- MODALS SECTION -->
    
    <!-- Auth Code Modal -->
    <div id="authCodeModal" class="modal fixed inset-0 z-50 bg-black bg-opacity-50 hidden opacity-0 flex items-center justify-center p-4">
        <div class="transform scale-95 bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 transition-all">
            <h3 class="text-xl font-bold text-slate-800 mb-4">Código de Autenticación</h3>
            <p class="text-sm text-slate-500 mb-4">Ingrese el código de autorización para crear un nuevo usuario.</p>
            <form id="authCodeForm">
                <input type="text" id="authCodeInput" placeholder="Código de Autorización" class="w-full p-2 border rounded-lg mb-4 uppercase text-center tracking-widest" required autocomplete="off">
                <p id="authCodeError" class="text-red-500 text-center mb-4 text-sm font-semibold hidden"></p>
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancelAuthCode" class="bg-slate-200 text-slate-800 px-4 py-2 rounded-lg font-semibold">Cancelar</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold">Validar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create User Modal -->
    <div id="createUserModal" class="modal fixed inset-0 z-50 bg-black bg-opacity-50 hidden opacity-0 flex items-center justify-center p-4">
        <div class="transform scale-95 bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 transition-all">
            <h3 class="text-xl font-bold text-slate-800 mb-4">Crear Nuevo Usuario</h3>
            <p class="text-sm text-slate-500 mb-4">Cree una cuenta para acceder al inventario.</p>
            <form id="createUserForm">
                <input type="email" id="newUserEmail" placeholder="Email" class="w-full p-2 border rounded-lg mb-4" required>
                <input type="password" id="newUserPassword" placeholder="Contraseña (mínimo 6 caracteres)" class="w-full p-2 border rounded-lg mb-4" required>
                <p id="createUserError" class="text-red-500 text-center mb-4 text-sm font-semibold hidden"></p>
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancelCreateUser" class="bg-slate-200 text-slate-800 px-4 py-2 rounded-lg font-semibold">Cancelar</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold">Crear</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Stock Modal -->
    <div id="stockModal" class="modal fixed inset-0 z-50 bg-black bg-opacity-50 hidden opacity-0 flex items-center justify-center p-4">
        <div class="transform scale-95 bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 transition-all">
            <h3 id="stockModalTitle" class="text-xl font-bold text-slate-800 mb-4">Añadir Nuevo Producto</h3>
            <form id="stockForm">
                <input type="hidden" id="stockDocId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="stockCode" placeholder="Código" class="w-full p-2 border rounded-lg" required>
                    <input type="text" id="stockCategory" placeholder="Categoría" class="w-full p-2 border rounded-lg" list="category-list" required>
                    <datalist id="category-list"></datalist>
                    <input type="text" id="stockProduct" placeholder="Nombre del Producto" class="md:col-span-2 w-full p-2 border rounded-lg" required>
                    <input type="text" id="stockUnit" placeholder="Unidad de Medida (U/M)" class="w-full p-2 border rounded-lg" list="unit-list" required>
                    <datalist id="unit-list"></datalist>
                    <input type="number" id="stockQuantity" placeholder="Cantidad Inicial" class="w-full p-2 border rounded-lg" min="0" required>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancelStock" class="bg-slate-200 text-slate-800 px-4 py-2 rounded-lg font-semibold">Cancelar</button>
                    <button type="submit" id="saveStockBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Entry Modal -->
    <div id="entryModal" class="modal fixed inset-0 z-50 bg-black bg-opacity-50 hidden opacity-0 flex items-center justify-center p-4">
        <div class="transform scale-95 bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 transition-all">
            <h3 class="text-xl font-bold text-slate-800 mb-4">Registrar Entrada</h3>
            <form id="entryForm">
                <div class="space-y-4">
                    <input type="date" id="entryDate" class="w-full p-2 border rounded-lg" required>
                    <div class="relative">
                       <input type="text" id="entryProduct" placeholder="Buscar producto por nombre o código..." class="w-full p-2 border rounded-lg" autocomplete="off">
                       <div id="entryProductSuggestions" class="absolute z-10 w-full bg-white border rounded-lg mt-1 max-h-60 overflow-y-auto hidden"></div>
                    </div>
                    <input type="number" id="entryQuantity" placeholder="Cantidad" class="w-full p-2 border rounded-lg" min="1" required>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancelEntry" class="bg-slate-200 text-slate-800 px-4 py-2 rounded-lg font-semibold">Cancelar</button>
                    <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold">Registrar Entrada</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Exit Modal -->
    <div id="exitModal" class="modal fixed inset-0 z-50 bg-black bg-opacity-50 hidden opacity-0 flex items-center justify-center p-4">
        <div class="transform scale-95 bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 transition-all">
            <h3 class="text-xl font-bold text-slate-800 mb-4">Registrar Salida</h3>
            <form id="exitForm">
                 <div class="space-y-4">
                    <input type="date" id="exitDate" class="w-full p-2 border rounded-lg" required>
                    <select id="exitProductSelect" class="w-full p-2 border rounded-lg bg-white" required></select>
                     <div class="grid grid-cols-2 gap-4 items-center">
                         <input type="number" id="exitQuantity" placeholder="Cantidad" class="w-full p-2 border rounded-lg" min="0">
                         <input type="text" id="exitQuantity2" placeholder="Ej: 5*2+3" class="w-full p-2 border rounded-lg text-center" title="Puede usar cálculos simples (suma, resta, multiplicación).">
                     </div>
                     <div class="text-center font-bold text-xl text-slate-700">
                         Total a retirar: <span id="exitTotalDisplay" class="text-red-600">0</span>
                     </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancelExit" class="bg-slate-200 text-slate-800 px-4 py-2 rounded-lg font-semibold">Cancelar</button>
                    <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold">Registrar Salida</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Paste from CSV Modal -->
    <div id="pasteModal" class="modal fixed inset-0 z-50 bg-black bg-opacity-50 hidden opacity-0 flex items-center justify-center p-4">
        <div class="transform scale-95 bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 transition-all">
            <h3 class="text-xl font-bold text-slate-800 mb-4">Pegar Datos desde Hoja de Cálculo</h3>
            <p class="text-sm text-slate-500 mb-4">Copie los datos (incluyendo encabezados: CODIGO, CATEGORIA, PRODUCTO, U/M, INICIAL) y péguelos aquí.</p>
            <textarea id="pasteData" rows="10" class="w-full p-2 border rounded-lg font-mono text-sm"></textarea>
            <div class="flex justify-end gap-3 mt-6">
                <button type="button" id="cancelPaste" class="bg-slate-200 text-slate-800 px-4 py-2 rounded-lg font-semibold">Cancelar</button>
                <button type="button" id="processPasteBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold">Procesar Datos</button>
            </div>
        </div>
    </div>
    
    <!-- Save Month Modal -->
    <div id="saveMonthModal" class="modal fixed inset-0 z-50 bg-black bg-opacity-50 hidden opacity-0 flex items-center justify-center p-4">
        <div class="transform scale-95 bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 transition-all">
            <h3 class="text-xl font-bold text-slate-800 mb-4">Archivar y Cerrar Mes</h3>
            <p class="text-sm text-slate-500 mb-4">Seleccione el mes y año a cerrar. Esto guardará un reporte y reiniciará el inventario con el stock final actual.</p>
            <div class="flex gap-4">
                <select id="saveMonthSelect" class="w-full p-2 border rounded-lg bg-white"></select>
                <input type="number" id="saveYearInput" class="w-full p-2 border rounded-lg">
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button type="button" id="cancelSaveMonth" class="bg-slate-200 text-slate-800 px-4 py-2 rounded-lg font-semibold">Cancelar</button>
                <button type="button" id="archiveAndFinalizeBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold">Archivar y Reiniciar</button>
            </div>
        </div>
    </div>

    <!-- Universal Confirmation / Notification Modal -->
    <div id="confirmModal" class="modal fixed inset-0 z-50 bg-black bg-opacity-50 hidden opacity-0 flex items-center justify-center p-4">
        <div class="transform scale-95 bg-white rounded-xl shadow-2xl w-full max-w-sm p-8 transition-all text-center">
            <div id="confirmModalIcon" class="mb-4"></div>
            <h3 id="confirmModalTitle" class="text-xl font-bold text-slate-800 mb-2"></h3>
            <p id="confirmModalMessage" class="text-slate-600 mb-6"></p>
            <div id="confirmModalButtons" class="flex justify-center gap-4">
                <button id="confirmCancelBtn" class="bg-slate-200 text-slate-800 px-6 py-2 rounded-lg font-semibold">Cancelar</button>
                <button id="confirmAcceptBtn" class="bg-red-600 text-white px-6 py-2 rounded-lg font-semibold">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- Archives List Modal -->
    <div id="archivesListModal" class="modal fixed inset-0 z-50 bg-black bg-opacity-50 hidden opacity-0 flex items-center justify-center p-4">
        <div class="transform scale-95 bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-slate-800">Inventarios Archivados</h3>
                <button id="closeArchivesList" class="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
            </div>
            <div id="archivesListContainer" class="max-h-96 overflow-y-auto divide-y"></div>
        </div>
    </div>

    <!-- Report Detail Modal -->
    <div id="reportDetailModal" class="modal fixed inset-0 z-50 bg-black bg-opacity-75 hidden opacity-0 flex items-center justify-center p-4">
        <div class="transform scale-95 bg-slate-50 rounded-xl shadow-2xl w-full max-w-6xl transition-all h-[90vh] flex flex-col">
             <div class="flex justify-between items-center p-4 border-b">
                <h3 id="reportDetailTitle" class="text-xl font-bold text-slate-800">Detalle de Reporte</h3>
                <div class="flex items-center gap-4">
                    <button data-action="export-report" class="bg-green-600 text-white font-bold py-2 px-3 rounded-lg text-sm hover:bg-green-700"><i class="fas fa-file-excel mr-1"></i> Exportar</button>
                    <button id="closeReportDetailIcon" class="text-slate-500 hover:text-slate-800 text-3xl">&times;</button>
                </div>
            </div>
            <div id="reportDetailContent" class="p-6 overflow-y-auto"></div>
            <div class="flex justify-end gap-4 p-4 mt-auto border-t">
                <button id="closeReportDetailBtn" class="bg-slate-200 text-slate-800 px-4 py-2 rounded-lg font-semibold hover:bg-slate-300">Cerrar</button>
           </div>
        </div>
    </div>

<!-- Firebase SDKs -->
<script type="module">
    // Import SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
        getAuth, 
        onAuthStateChanged,
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
        getFirestore, 
        collection, 
        doc,
        setDoc,
        deleteDoc,
        onSnapshot,
        writeBatch,
        getDocs,
        query
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDRAPx_THFmyDNagZgVuhtWhUZdB8LHKLE",
      authDomain: "databasejgm-900ec.firebaseapp.com",
      projectId: "databasejgm-900ec",
      storageBucket: "databasejgm-900ec.firebasestorage.app",
      messagingSenderId: "385826567780",
      appId: "1:385826567780:web:89b41e6aa2b1a6a78e5171",
      measurementId: "G-JFYRC53F07"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- GLOBAL APP STATE ---
    let currentUser = null;
    let allInitial = [];
    let allEntries = [];
    let allExits = [];
    let monthlyReports = [];
    let currentStock = [];
    
    let currentTab = 'stock';
    let selectedProductForEntry = null;
    let currentReportData = null;
    let annualChart = null;
    let confirmCallback = null;
    
    // Unsubscribe functions for Firestore listeners
    let unsubInitial, unsubEntries, unsubExits, unsubReports;

    // --- DOM Elements ---
    const landingScreen = document.getElementById('landing-screen');
    const loginScreen = document.getElementById('login-screen');
    const appContainer = document.getElementById('app');
    const syncBtn = document.getElementById('syncDataBtn');

    // --- UTILITY & UI FUNCTIONS ---
    function toggleModal(modal, show) {
        if (!modal) return;
        const transformTarget = modal.querySelector('.transform');
        if (show) {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                if (transformTarget) transformTarget.classList.remove('scale-95');
            }, 10);
        } else {
            modal.classList.add('opacity-0');
            if (transformTarget) transformTarget.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
    }

    function showNotification({ title, message, isError = false, duration = 3000 }) {
        const confirmModal = document.getElementById('confirmModal');
        if (!confirmModal) return;
        document.getElementById('confirmModalTitle').textContent = title;
        document.getElementById('confirmModalMessage').textContent = message;
        document.getElementById('confirmModalIcon').innerHTML = isError 
            ? `<i class="fas fa-times-circle fa-3x text-red-500"></i>` 
            : `<i class="fas fa-check-circle fa-3x text-green-500"></i>`;
        document.getElementById('confirmModalButtons').style.display = 'none';
        toggleModal(confirmModal, true);
        setTimeout(() => {
            toggleModal(confirmModal, false);
            setTimeout(()=> document.getElementById('confirmModalButtons').style.display = 'flex', 300);
        }, duration);
    }
    
    function showConfirmModal({ title, message, onConfirm }) {
        const confirmModal = document.getElementById('confirmModal');
        if (!confirmModal) return;
        document.getElementById('confirmModalTitle').textContent = title;
        document.getElementById('confirmModalMessage').textContent = message;
        document.getElementById('confirmModalIcon').innerHTML = `<i class="fas fa-exclamation-triangle fa-3x text-yellow-500"></i>`;
        document.getElementById('confirmModalButtons').style.display = 'flex';
        confirmCallback = onConfirm;
        toggleModal(confirmModal, true);
    }
    
    function updateSyncStatus(isSyncing) {
        if (isSyncing) {
            syncBtn.classList.add('syncing');
            syncBtn.title = 'Sincronizando...';
        } else {
            syncBtn.classList.remove('syncing');
            syncBtn.title = 'Sincronizado';
        }
    }
    
    const sortProductsByCode = (a, b) => (a.code || '').localeCompare(b.code || '');

    // --- CORE LOGIC ---
    function calculateCurrentStock() {
        const stockMap = new Map();
        allInitial.forEach(item => {
            stockMap.set(item.code, { ...item, quantity: Number(item.quantity) });
        });
        allEntries.forEach(entry => {
            if (stockMap.has(entry.code)) {
                stockMap.get(entry.code).quantity += Number(entry.quantity);
            }
        });
        allExits.forEach(exit => {
            if (stockMap.has(exit.code)) {
                stockMap.get(exit.code).quantity -= Number(exit.quantity);
            }
        });
        currentStock = Array.from(stockMap.values());
    }

    function calculateFinalInventory() {
        const inventoryMap = new Map();
        allInitial.forEach(item => {
            inventoryMap.set(item.code, {
                ...item,
                initial: Number(item.quantity),
                entries: 0,
                exits: 0,
                final: Number(item.quantity)
            });
        });
        allEntries.forEach(entry => {
            if (inventoryMap.has(entry.code)) {
                const item = inventoryMap.get(entry.code);
                item.entries += Number(entry.quantity);
                item.final += Number(entry.quantity);
            }
        });
        allExits.forEach(exit => {
            if (inventoryMap.has(exit.code)) {
                const item = inventoryMap.get(exit.code);
                item.exits += Number(exit.quantity);
                item.final -= Number(exit.quantity);
            }
        });
        return Array.from(inventoryMap.values());
    }

    function calculateAndRenderAll() {
        calculateCurrentStock();
        updateExitModalProductList();
        renderCurrentTab();
    }
    
    // --- AUTHENTICATION ---
    function setupAuth() {
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                showApp();
                initializeAppState();
            } else {
                currentUser = null;
                showLanding();
                cleanupListeners();
            }
        });

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('loginError');
            try {
                errorEl.classList.add('hidden');
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                errorEl.textContent = 'Email o contraseña incorrectos.';
                errorEl.classList.remove('hidden');
            }
        });
        
        const togglePasswordBtn = document.getElementById('togglePassword');
        togglePasswordBtn.addEventListener('click', () => {
            const passwordInput = document.getElementById('password');
            const toggleIcon = togglePasswordBtn.querySelector('i');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            toggleIcon.classList.toggle('fa-eye');
            toggleIcon.classList.toggle('fa-eye-slash');
        });

        // --- NEW USER REGISTRATION FLOW ---
        document.getElementById('showCreateUserModalBtn').addEventListener('click', () => {
            document.getElementById('authCodeForm').reset();
            document.getElementById('authCodeError').classList.add('hidden');
            toggleModal(document.getElementById('authCodeModal'), true);
        });

        document.getElementById('cancelAuthCode').addEventListener('click', () => {
            toggleModal(document.getElementById('authCodeModal'), false);
        });

        document.getElementById('authCodeForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const inputCode = document.getElementById('authCodeInput').value;
            const errorEl = document.getElementById('authCodeError');
            const AUTH_CODE = "JGM2025"; // Master authorization code

            if (inputCode.toUpperCase() === AUTH_CODE) {
                toggleModal(document.getElementById('authCodeModal'), false);
                document.getElementById('createUserForm').reset();
                document.getElementById('createUserError').classList.add('hidden');
                toggleModal(document.getElementById('createUserModal'), true);
                errorEl.classList.add('hidden');
            } else {
                errorEl.textContent = 'Código de autorización incorrecto.';
                errorEl.classList.remove('hidden');
            }
        });
        
        document.getElementById('cancelCreateUser').addEventListener('click', () => {
            toggleModal(document.getElementById('createUserModal'), false);
        });

        document.getElementById('createUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('newUserEmail').value;
            const password = document.getElementById('newUserPassword').value;
            const errorEl = document.getElementById('createUserError');
            try {
                errorEl.classList.add('hidden');
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                toggleModal(document.getElementById('createUserModal'), false);
                showNotification({title: "¡Éxito!", message: `Usuario ${userCredential.user.email} creado.`});
            } catch (error) {
                if (error.code === 'auth/weak-password') {
                   errorEl.textContent = 'La contraseña debe tener al menos 6 caracteres.';
                } else if (error.code === 'auth/email-already-in-use') {
                    errorEl.textContent = 'Este email ya está en uso.';
                } else {
                    errorEl.textContent = 'Ocurrió un error al crear el usuario.';
                }
                errorEl.classList.remove('hidden');
            }
        });
    }

    function handleLogout() {
        signOut(auth).catch(error => console.error("Logout error", error));
    }

    function showApp() {
        landingScreen.style.display = 'none';
        loginScreen.classList.remove('flex');
        loginScreen.classList.add('hidden');
        appContainer.classList.remove('hidden');
    }

    function showLogin() {
        landingScreen.style.display = 'none';
        appContainer.classList.add('hidden');
        loginScreen.classList.remove('hidden');
        loginScreen.classList.add('flex');
    }

    function showLanding() {
        appContainer.classList.add('hidden');
        loginScreen.classList.remove('flex');
        loginScreen.classList.add('hidden');
        landingScreen.style.display = 'flex';
    }


    // --- FIRESTORE DATA HANDLING ---
    function initializeAppState() {
        if (!currentUser) return;
        updateSyncStatus(true);
        
        const initialRef = collection(db, "users", currentUser.uid, "initial_inventory");
        unsubInitial = onSnapshot(initialRef, (snapshot) => {
            allInitial = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            calculateAndRenderAll();
            updateSyncStatus(false);
        }, err => { console.error(err); updateSyncStatus(false); });

        const entriesRef = collection(db, "users", currentUser.uid, "entries");
        unsubEntries = onSnapshot(entriesRef, (snapshot) => {
            allEntries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            calculateAndRenderAll();
        });

        const exitsRef = collection(db, "users", currentUser.uid, "exits");
        unsubExits = onSnapshot(exitsRef, (snapshot) => {
            allExits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            calculateAndRenderAll();
        });

        const reportsRef = collection(db, "users", currentUser.uid, "monthly_reports");
        unsubReports = onSnapshot(query(reportsRef), (snapshot) => {
            monthlyReports = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        });
    }

    function cleanupListeners() {
        if (unsubInitial) unsubInitial();
        if (unsubEntries) unsubEntries();
        if (unsubExits) unsubExits();
        if (unsubReports) unsubReports();
    }

    async function addOrUpdateDoc(collectionName, data, docId) {
        if (!currentUser) return;
        const id = docId || crypto.randomUUID();
        const docRef = doc(db, "users", currentUser.uid, collectionName, id);
        await setDoc(docRef, { ...data, id });
        return id;
    }

    async function deleteDocument(collectionName, docId) {
        if (!currentUser) return;
        const docRef = doc(db, "users", currentUser.uid, collectionName, docId);
        await deleteDoc(docRef);
    }

    async function clearCollection(collectionName) {
        if (!currentUser) return;
        const collRef = collection(db, "users", currentUser.uid, collectionName);
        const snapshot = await getDocs(collRef);
        const batch = writeBatch(db);
        snapshot.docs.forEach(doc => {
            batch.delete(doc.ref);
        });
        await batch.commit();
    }
    
    // --- IMPORT / EXPORT & MONTHLY CLOSING ---
    function downloadCSVTemplate() {
        const headers = "CODIGO;CATEGORIA;PRODUCTO;U/M;INICIAL";
        const blob = new Blob(["\uFEFF" + headers], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "plantilla_inventario.csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            delimiter: ";",
            complete: (results) => {
                if (results.errors.length > 0) {
                    showNotification({ title: 'Error de Lectura', message: 'El archivo CSV tiene un formato incorrecto.', isError: true });
                    return;
                }
                processAndSaveProducts(results.data);
            }
        });
        event.target.value = ''; // Reset file input
    }
    
    function handlePasteData() {
        const text = document.getElementById('pasteData').value;
        if (!text.trim()) return;
        Papa.parse(text, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
                if (results.errors.length > 0) {
                    showNotification({ title: 'Error de Pegado', message: 'El formato es incorrecto.', isError: true });
                    return;
                }
                processAndSaveProducts(results.data);
                toggleModal(document.getElementById('pasteModal'), false);
            }
        });
    }

    async function processAndSaveProducts(products) {
        if (!currentUser) return;
        const validProducts = [];
        const errors = [];

        for (const row of products) {
            const isRowEmpty = Object.values(row).every(val => typeof val !== 'string' || !val.trim());
            if (isRowEmpty) continue;

            const code = (row.CODIGO || row.code)?.trim().toUpperCase();
            const category = (row.CATEGORIA || row.category)?.trim();
            const prodName = (row.PRODUCTO || row.product)?.trim();
            const unit = (row['U/M'] || row.unit)?.trim();
            const quantity = Number((row.INICIAL || row.quantity)?.toString().trim());
            
            if (code && category && prodName && unit && !isNaN(quantity) && quantity >= 0) {
                validProducts.push({ code, category, product: prodName, unit, quantity });
            } else {
                errors.push(prodName || `Fila #${products.indexOf(row) + 1}`);
            }
        }

        if (errors.length > 0) {
            showNotification({ title: 'Errores de Validación', message: `Se ignoraron ${errors.length} filas por datos incompletos.`, isError: true, duration: 5000 });
        }

        if (validProducts.length > 0) {
            const batch = writeBatch(db);
            validProducts.forEach(product => {
                const docRef = doc(collection(db, "users", currentUser.uid, "initial_inventory"));
                batch.set(docRef, { ...product, id: docRef.id });
            });
            await batch.commit();
            showNotification({ title: 'Éxito', message: `${validProducts.length} productos importados correctamente.` });
        }
    }

    async function handleSaveMonth() {
        toggleModal(document.getElementById('saveMonthModal'), false);
        const monthIndex = document.getElementById('saveMonthSelect').value;
        const year = document.getElementById('saveYearInput').value;
        if (!monthIndex || !year || year.length < 4) {
            showNotification({title: "Datos Incompletos", message: "Debe seleccionar un mes y un año válido.", isError: true});
            return;
        }
        const monthName = document.getElementById('saveMonthSelect').options[document.getElementById('saveMonthSelect').selectedIndex].text;
        
        showConfirmModal({
            title: `Archivar ${monthName} ${year}`,
            message: 'Esta acción guardará un reporte, reiniciará el inventario con el stock final y borrará las entradas/salidas actuales. ¿Continuar?',
            onConfirm: async () => {
                if(!currentUser) return;
                const finalInventory = calculateFinalInventory();
                const reportId = `${year}-${String(Number(monthIndex) + 1).padStart(2, '0')}`;
                
                const reportData = {
                    year: Number(year),
                    month: Number(monthIndex) + 1,
                    entries: [...allEntries],
                    exits: [...allExits],
                    finalInventory: finalInventory
                };

                const batch = writeBatch(db);

                // 1. Save the monthly report
                const reportRef = doc(db, "users", currentUser.uid, "monthly_reports", reportId);
                batch.set(reportRef, { ...reportData, id: reportId });

                // 2. Clear old initial inventory
                const initialSnapshot = await getDocs(collection(db, "users", currentUser.uid, "initial_inventory"));
                initialSnapshot.forEach(doc => batch.delete(doc.ref));

                // 3. Set new initial inventory from final stock
                finalInventory.forEach(item => {
                    const newInitialData = { code: item.code, category: item.category, product: item.product, unit: item.unit, quantity: item.final };
                    const newDocRef = doc(collection(db, "users", currentUser.uid, "initial_inventory"));
                    batch.set(newDocRef, { ...newInitialData, id: newDocRef.id });
                });
                
                // 4. Clear entries and exits
                const entriesSnapshot = await getDocs(collection(db, "users", currentUser.uid, "entries"));
                entriesSnapshot.forEach(doc => batch.delete(doc.ref));
                const exitsSnapshot = await getDocs(collection(db, "users", currentUser.uid, "exits"));
                exitsSnapshot.forEach(doc => batch.delete(doc.ref));

                try {
                    await batch.commit();
                    showNotification({ title: "Éxito", message: `Inventario de ${monthName} ${year} archivado y reiniciado.` });
                } catch (error) {
                    console.error("Monthly closing error:", error);
                    showNotification({ title: "Error", message: "No se pudo completar el cierre mensual.", isError: true });
                }
            }
        });
    }

    // --- RENDERING & REPORTS ---
    function renderCurrentTab() {
        if (currentTab === 'annual_report') {
            renderAnnualReport();
            return;
        }

        const headers = {
            stock: ['Código', 'Categoría', 'Producto', 'U/M', 'Stock'],
            movements: ['Fecha', 'Código', 'Categoría', 'Producto', 'U/M', 'Cantidad', 'Acciones'],
            initial: ['Código', 'Categoría', 'Producto', 'U/M', 'Cantidad Inicial', 'Acciones'],
            final: ['Código', 'Categoría', 'Producto', 'U/M', 'Inv. Inicial', 'Entradas', 'Salidas', 'Stock Final']
        };
        const rowTemplates = {
            stock: item => `<td>${item.code}</td><td>${item.category}</td><td>${item.product}</td><td>${item.unit}</td><td class="font-bold">${item.quantity}</td>`,
            entries: item => `<td>${item.date}</td><td>${item.code}</td><td>${item.category}</td><td>${item.product}</td><td>${item.unit}</td><td class="text-green-600 font-bold">+${item.quantity}</td><td><button data-action="delete-row" data-collection="entries" data-id="${item.id}" class="delete-btn text-gray-400 hover:text-red-500 p-2"><i class="fas fa-trash-alt"></i></button></td>`,
            exits: item => `<td>${item.date}</td><td>${item.code}</td><td>${item.category}</td><td>${item.product}</td><td>${item.unit}</td><td class="text-red-600 font-bold">-${item.quantity}</td><td><button data-action="delete-row" data-collection="exits" data-id="${item.id}" class="delete-btn text-gray-400 hover:text-red-500 p-2"><i class="fas fa-trash-alt"></i></button></td>`,
            initial: item => `<td>${item.code}</td><td>${item.category}</td><td>${item.product}</td><td>${item.unit}</td><td>${item.quantity}</td><td class="flex gap-2"><button data-action="edit-stock" data-id="${item.id}" class="action-btn text-gray-400 hover:text-indigo-600 p-2"><i class="fas fa-pencil-alt"></i></button><button data-action="delete-row" data-collection="initial_inventory" data-id="${item.id}" class="delete-btn text-gray-400 hover:text-red-500 p-2"><i class="fas fa-trash-alt"></i></button></td>`,
            final: item => `<td>${item.code}</td><td>${item.category}</td><td>${item.product}</td><td>${item.unit}</td><td>${item.initial}</td><td class="text-green-600">+${item.entries}</td><td class="text-red-600">-${item.exits}</td><td class="font-bold">${item.final}</td>`
        };
        
        switch (currentTab) {
            case 'stock': renderTable('Stock Actual', headers.stock, [...currentStock].sort(sortProductsByCode), rowTemplates.stock, { showSearch: true }); break;
            case 'entries': renderTable('Entradas', headers.movements, [...allEntries].sort(sortProductsByCode), rowTemplates.entries, { showClear: true, collectionName: "Entradas", collectionId: "entries" }); break;
            case 'exits': renderTable('Salidas', headers.movements, [...allExits].sort(sortProductsByCode), rowTemplates.exits, { showClear: true, collectionName: "Salidas", collectionId: "exits" }); break;
            case 'initial': renderTable('Inv. Inicial', headers.initial, [...allInitial].sort(sortProductsByCode), rowTemplates.initial, { showClear: true, showAdd: true, showImportExport: true, collectionName: "Inventario Inicial", collectionId: "initial_inventory" }); break;
            case 'final': renderTable('Inv. Final', headers.final, calculateFinalInventory().sort(sortProductsByCode), rowTemplates.final, { showSearch: true }); break;
        }
    }
    
    function renderTable(title, headers, data, rowTemplate, options = {}) {
        const tableHeaders = headers.map(h => `<th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">${h}</th>`).join('');
        const tableRows = data.map(item => `<tr class="hover:bg-slate-50 even:bg-white">${rowTemplate(item).replace(/<td>/g, '<td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">')}</tr>`).join('');
        
        const importExportButtons = options.showImportExport ? `
            <button data-action="download-template" class="bg-slate-600 text-white font-bold py-2 px-3 rounded-lg text-sm hover:bg-slate-700"><i class="fas fa-download mr-1"></i> Descargar</button>
            <button data-action="upload-template" class="bg-green-600 text-white font-bold py-2 px-3 rounded-lg text-sm hover:bg-green-700"><i class="fas fa-upload mr-1"></i> Cargar</button>
            <button data-action="paste-template" class="bg-blue-600 text-white font-bold py-2 px-3 rounded-lg text-sm hover:bg-blue-700"><i class="fas fa-paste mr-1"></i> Pegar</button>
        ` : '';

        let headerButtons = `<h2 class="text-xl font-semibold text-slate-800">${title}</h2>`;
        if(options.showAdd || options.showClear || options.showImportExport) {
                headerButtons = `<div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                    <h2 class="text-xl font-semibold text-slate-800">${title}</h2>
                    <div class="flex flex-wrap gap-2">
                        ${importExportButtons}
                        ${options.showAdd ? `<button data-action="add-stock" class="bg-indigo-500 text-white font-bold py-2 px-3 rounded-lg text-sm hover:bg-indigo-600"><i class="fas fa-plus mr-1"></i> Añadir Producto</button>` : ''}
                        ${options.showClear ? `<button data-action="clear-collection" data-collection="${options.collectionId}" data-name="${options.collectionName}" class="text-sm text-red-500 hover:text-red-700 font-semibold"><i class="fas fa-eraser mr-1"></i> Limpiar Todo</button>` : ''}
                    </div>
                </div>`;
        }

        const searchBar = options.showSearch ? `
            <div class="relative mb-4">
                <input type="search" data-table-search class="w-full pl-10 pr-4 py-2 border rounded-lg" placeholder="Buscar en la tabla...">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>
        ` : '';

        document.getElementById('tab-content').innerHTML = `
            ${headerButtons}
            ${searchBar}
            <div class="border border-slate-200 rounded-lg overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200"><thead class="bg-slate-50 sticky top-0 z-10"><tr>${tableHeaders}</tr></thead>
                    <tbody class="bg-white divide-y divide-slate-200">${tableRows || `<tr><td colspan="${headers.length}" class="text-center py-10 text-slate-500">No hay datos para mostrar.</td></tr>`}</tbody>
                </table>
            </div>`;
        
        const searchInput = document.querySelector('[data-table-search]');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const tableRows = document.querySelectorAll('#tab-content tbody tr');
                tableRows.forEach(row => {
                    row.style.display = row.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
                });
            });
        }
    }

    function renderAnnualReport() {
        const tabContent = document.getElementById('tab-content');
        const categories = ['Todas', ...new Set(allInitial.map(p => p.category).sort())];
        
        tabContent.innerHTML = `
            <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                <h2 class="text-xl font-semibold text-slate-800">Reporte Anual</h2>
                <div class="flex gap-4">
                    <select id="reportCategory" class="p-2 border border-slate-300 rounded-lg bg-white">
                        ${categories.map(c => `<option value="${c}">${c}</option>`).join('')}
                    </select>
                    <input type="number" id="reportYear" class="w-28 p-2 border border-slate-300 rounded-lg" value="${new Date().getFullYear()}">
                </div>
            </div>
            <div class="h-96 w-full"><canvas id="annualChart"></canvas></div>`;
        
        const renderChart = () => {
            const year = document.getElementById('reportYear').value;
            const category = document.getElementById('reportCategory').value;
            if (!year) return;

            const monthlyData = Object.fromEntries(Array.from({length: 12}, (_, i) => [i, { entries: 0, exits: 0 }]));

            monthlyReports.forEach(report => {
                if (report.year == year) {
                    const reportMonthIndex = report.month - 1;
                    const filterCategory = (item) => category === 'Todas' || item.category === category;
                    const totalEntries = report.entries?.filter(filterCategory).reduce((sum, item) => sum + Number(item.quantity), 0) || 0;
                    const totalExits = report.exits?.filter(filterCategory).reduce((sum, item) => sum + Number(item.quantity), 0) || 0;
                    monthlyData[reportMonthIndex] = { entries: totalEntries, exits: totalExits };
                }
            });

            const chartData = {
                labels: ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"],
                datasets: [
                    { label: 'Entradas', data: Object.values(monthlyData).map(d => d.entries), backgroundColor: 'rgba(75, 192, 192, 0.6)' },
                    { label: 'Salidas', data: Object.values(monthlyData).map(d => d.exits), backgroundColor: 'rgba(255, 99, 132, 0.6)' }
                ]
            };
            const ctx = document.getElementById('annualChart').getContext('2d');
            if (annualChart) annualChart.destroy();
            annualChart = new Chart(ctx, {
                type: 'bar', data: chartData,
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        };

        document.getElementById('reportYear').addEventListener('change', renderChart);
        document.getElementById('reportCategory').addEventListener('change', renderChart);
        renderChart();
    }
    
    function handleViewArchives() {
        const container = document.getElementById('archivesListContainer');
        if (monthlyReports.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay inventarios archivados.</p>';
        } else {
            const reports = [...monthlyReports].sort((a,b) => b.id.localeCompare(a.id));
            const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            container.innerHTML = reports.map(report => `
                <button data-action="view-report" data-id="${report.id}" class="w-full text-left p-4 hover:bg-gray-100 flex justify-between items-center">
                    <span class="font-semibold text-indigo-600">${months[report.month - 1]} ${report.year}</span>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </button>
            `).join('');
        }
        toggleModal(document.getElementById('archivesListModal'), true);
    }

    function handleViewReportDetail(reportId) {
        const report = monthlyReports.find(r => r.id === reportId);
        if (!report) return;
        currentReportData = report; // Store for export
        const { finalInventory, entries, exits, month, year } = report;
        const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        document.getElementById('reportDetailTitle').textContent = `Detalle de ${months[month - 1]} ${year}`;
        
        const createTableHTML = (title, headers, data, rowTemplate) => {
            const tableHeaders = headers.map(h => `<th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">${h}</th>`).join('');
            const tableRows = data.map(item => `<tr class="bg-white hover:bg-slate-50">${rowTemplate(item).replace(/<td>/g, '<td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">')}</tr>`).join('');
            return `<h3 class="text-lg font-semibold text-slate-800 mt-6 mb-2">${title}</h3>
                    <div class="border border-slate-200 rounded-lg max-h-64 overflow-y-auto">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50 sticky top-0"><tr>${tableHeaders}</tr></thead>
                            <tbody class="divide-y divide-slate-200">${tableRows || `<tr><td colspan="${headers.length}" class="text-center py-10">No hay datos.</td></tr>`}</tbody>
                        </table>
                    </div>`;
        };
        
        const finalInvHeaders = ['Código', 'Categoría', 'Producto', 'U/M', 'Inv. Inicial', 'Entradas', 'Salidas', 'Stock Final'];
        const movementHeaders = ['Fecha', 'Código', 'Categoría', 'Producto', 'U/M', 'Cantidad'];
        const finalRow = item => `<td>${item.code}</td><td>${item.category}</td><td>${item.product}</td><td>${item.unit}</td><td>${item.initial}</td><td class="text-green-600">+${item.entries}</td><td class="text-red-600">-${item.exits}</td><td class="font-bold">${item.final}</td>`;
        const entryRow = item => `<td>${item.date}</td><td>${item.code}</td><td>${item.category}</td><td>${item.product}</td><td>${item.unit}</td><td class="text-green-600 font-bold">+${item.quantity}</td>`;
        const exitRow = item => `<td>${item.date}</td><td>${item.code}</td><td>${item.category}</td><td>${item.product}</td><td>${item.unit}</td><td class="text-red-600 font-bold">-${item.quantity}</td>`;

        document.getElementById('reportDetailContent').innerHTML = 
            createTableHTML('Inventario Final', finalInvHeaders, [...finalInventory].sort(sortProductsByCode), finalRow) +
            createTableHTML('Entradas del Mes', movementHeaders, [...entries].sort(sortProductsByCode), entryRow) +
            createTableHTML('Salidas del Mes', movementHeaders, [...exits].sort(sortProductsByCode), exitRow);
            
        toggleModal(document.getElementById('reportDetailModal'), true);
    }
    
    function handleExportReport() {
        if (!currentReportData) return;
        const { finalInventory, entries, exits, month, year } = currentReportData;
        const months = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
        const reportName = `Reporte_${months[month - 1]}_${year}.xlsx`;

        const wsFinal = XLSX.utils.json_to_sheet([...finalInventory].sort(sortProductsByCode).map(item => ({ 'Código': item.code, 'Categoría': item.category, 'Producto': item.product, 'U/M': item.unit, 'Inv. Inicial': item.initial, 'Entradas': item.entries, 'Salidas': item.exits, 'Stock Final': item.final })));
        const wsEntries = XLSX.utils.json_to_sheet([...entries].sort(sortProductsByCode).map(item => ({ 'Fecha': item.date, 'Código': item.code, 'Categoría': item.category, 'Producto': item.product, 'U/M': item.unit, 'Cantidad': item.quantity })));
        const wsExits = XLSX.utils.json_to_sheet([...exits].sort(sortProductsByCode).map(item => ({ 'Fecha': item.date, 'Código': item.code, 'Categoría': item.category, 'Producto': item.product, 'U/M': item.unit, 'Cantidad': item.quantity })));

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, wsFinal, "Inventario Final");
        XLSX.utils.book_append_sheet(wb, wsEntries, "Entradas del Mes");
        XLSX.utils.book_append_sheet(wb, wsExits, "Salidas del Mes");
        XLSX.writeFile(wb, reportName);
    }

    // --- EVENT HANDLERS ---
    function handleStockFormSubmit(e) {
        e.preventDefault();
        const docId = document.getElementById('stockDocId').value;
        const productData = {
            code: document.getElementById('stockCode').value.trim().toUpperCase(),
            category: document.getElementById('stockCategory').value.trim(),
            product: document.getElementById('stockProduct').value.trim(),
            unit: document.getElementById('stockUnit').value.trim(),
            quantity: Number(document.getElementById('stockQuantity').value)
        };
        addOrUpdateDoc('initial_inventory', productData, docId || null);
        toggleModal(document.getElementById('stockModal'), false);
    }
    
    function handleEntrySubmit(e) {
        e.preventDefault();
        if (!selectedProductForEntry) { 
            showNotification({title: "Error", message: "Por favor, seleccione un producto de la lista.", isError: true}); 
            return; 
        }
        const newEntry = {
            date: document.getElementById('entryDate').value,
            quantity: Number(document.getElementById('entryQuantity').value),
            code: selectedProductForEntry.code,
            product: selectedProductForEntry.product,
            category: selectedProductForEntry.category,
            unit: selectedProductForEntry.unit
        };
        if (!newEntry.date || !newEntry.code || newEntry.quantity <= 0) {
             showNotification({title: "Error", message: "Fecha y cantidad son requeridos.", isError: true});
             return;
        }
        addOrUpdateDoc('entries', newEntry);
        toggleModal(document.getElementById('entryModal'), false);
        document.getElementById('entryForm').reset();
        selectedProductForEntry = null;
    }
    
    function handleExitSubmit(e) {
        e.preventDefault();
        const productCode = document.getElementById('exitProductSelect').value;
        const date = document.getElementById('exitDate').value;
        const totalQuantity = Number(document.getElementById('exitTotalDisplay').textContent);
        const productInStock = currentStock.find(p => p.code === productCode);

        if (!date || !productInStock || totalQuantity <= 0) {
            showNotification({title:"Error de Salida", message: "Datos incorrectos.", isError: true});
            return;
        }
        if (totalQuantity > productInStock.quantity) {
            showNotification({title:"Stock Insuficiente", message: `Solo hay ${productInStock.quantity} en stock.`, isError: true});
            return;
        }
        const exitData = { date, quantity: totalQuantity, code: productInStock.code, product: productInStock.product, category: productInStock.category, unit: productInStock.unit };
        addOrUpdateDoc('exits', exitData);
        toggleModal(document.getElementById('exitModal'), false);
        document.getElementById('exitForm').reset();
    }
    
    function openStockModal(docId = null) {
        const form = document.getElementById('stockForm');
        form.reset();
        document.getElementById('stockDocId').value = '';
        
        document.getElementById('category-list').innerHTML = [...new Set(allInitial.map(p => p.category))].map(c => `<option value="${c}">`).join('');
        document.getElementById('unit-list').innerHTML = [...new Set(allInitial.map(p => p.unit))].map(u => `<option value="${u}">`).join('');

        if(docId) {
            const product = allInitial.find(p => p.id === docId);
            if(product) {
                document.getElementById('stockModalTitle').textContent = 'Editar Producto';
                document.getElementById('stockDocId').value = product.id;
                document.getElementById('stockCode').value = product.code;
                document.getElementById('stockCategory').value = product.category;
                document.getElementById('stockProduct').value = product.product;
                document.getElementById('stockUnit').value = product.unit;
                document.getElementById('stockQuantity').value = product.quantity;
            }
        } else {
            document.getElementById('stockModalTitle').textContent = 'Añadir Nuevo Producto';
        }
        toggleModal(document.getElementById('stockModal'), true);
    }
    
    function updateExitModalProductList() {
        const select = document.getElementById('exitProductSelect');
        const sortedProducts = [...currentStock].filter(p => p.quantity > 0).sort(sortProductsByCode);
        select.innerHTML = '<option value="" disabled selected>Seleccione un producto</option>';
        sortedProducts.forEach(item => {
            select.innerHTML += `<option value="${item.code}">${item.product} - ${item.code} (Stock: ${item.quantity})</option>`;
        });
    }

    function safeCalculate(expression) {
        if (typeof expression !== 'string' || !expression.trim()) return 0;
        let sanitized = expression.trim().replace(/x/gi, '*').replace(/[^0-9\.\+\-\*\/]/g, '');
        if (!sanitized) return 0;
        const lastChar = sanitized.slice(-1);
        if (['+', '-', '*', '/'].includes(lastChar)) sanitized = sanitized.slice(0, -1);
        if (!sanitized) return 0;
        try {
            const result = new Function('return ' + sanitized)();
            return isNaN(result) || !isFinite(result) ? 0 : result;
        } catch (e) { return 0; }
    }
    
    // --- EVENT LISTENER SETUP ---
    function setupEventListeners() {
        document.getElementById('logoutBtn').addEventListener('click', handleLogout);
        
        document.getElementById('tabs').addEventListener('click', (e) => {
            e.preventDefault();
            const tabLink = e.target.closest('.tab');
            if (tabLink && !tabLink.classList.contains('tab-active')) {
                document.querySelector('.tab-active').classList.remove('tab-active');
                tabLink.classList.add('tab-active');
                currentTab = tabLink.dataset.tab;
                calculateAndRenderAll();
            }
        });
        
        document.getElementById('openEntryModalBtn').addEventListener('click', () => {
            document.getElementById('entryForm').reset();
            document.getElementById('entryDate').valueAsDate = new Date();
            toggleModal(document.getElementById('entryModal'), true);
        });
        document.getElementById('openExitModalBtn').addEventListener('click', () => {
            document.getElementById('exitForm').reset();
            document.getElementById('exitDate').valueAsDate = new Date();
            document.getElementById('exitTotalDisplay').textContent = '0';
            toggleModal(document.getElementById('exitModal'), true);
        });
        document.getElementById('saveMonthBtn').addEventListener('click', () => {
            const monthSelect = document.getElementById('saveMonthSelect');
            const yearInput = document.getElementById('saveYearInput');
            const now = new Date();
            const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            monthSelect.innerHTML = months.map((m, i) => `<option value="${i}">${m}</option>`).join('');
            monthSelect.value = now.getMonth();
            yearInput.value = now.getFullYear();
            toggleModal(document.getElementById('saveMonthModal'), true);
        });
        
        document.getElementById('stockForm').addEventListener('submit', handleStockFormSubmit);
        document.getElementById('entryForm').addEventListener('submit', handleEntrySubmit);
        document.getElementById('exitForm').addEventListener('submit', handleExitSubmit);
        
        document.getElementById('cancelStock').addEventListener('click', () => toggleModal(document.getElementById('stockModal'), false));
        document.getElementById('cancelEntry').addEventListener('click', () => toggleModal(document.getElementById('entryModal'), false));
        document.getElementById('cancelExit').addEventListener('click', () => toggleModal(document.getElementById('exitModal'), false));
        document.getElementById('cancelPaste').addEventListener('click', () => toggleModal(document.getElementById('pasteModal'), false));
        document.getElementById('processPasteBtn').addEventListener('click', handlePasteData);
        document.getElementById('cancelSaveMonth').addEventListener('click', () => toggleModal(document.getElementById('saveMonthModal'), false));
        document.getElementById('archiveAndFinalizeBtn').addEventListener('click', handleSaveMonth);

        document.getElementById('entryProduct').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const suggestionsContainer = document.getElementById('entryProductSuggestions');
            selectedProductForEntry = null;
            if (searchTerm.length < 1) {
                suggestionsContainer.classList.add('hidden');
                return;
            }
            const suggestions = [...allInitial]
                .filter(item => item.product.toLowerCase().includes(searchTerm) || item.code.toLowerCase().includes(searchTerm))
                .sort(sortProductsByCode);
            
            if (suggestions.length > 0) {
                suggestionsContainer.innerHTML = suggestions.map(item => 
                    `<div class="p-3 hover:bg-indigo-100 cursor-pointer" data-product-id="${item.id}">
                        ${item.product} <span class="text-xs text-gray-500">(${item.code})</span>
                       </div>`
                ).join('');
                suggestionsContainer.classList.remove('hidden');
            } else {
                suggestionsContainer.classList.add('hidden');
            }
        });

        document.getElementById('entryProductSuggestions').addEventListener('click', (e) => {
            const target = e.target.closest('[data-product-id]');
            if (target) {
                selectedProductForEntry = allInitial.find(p => p.id === target.dataset.productId);
                if (selectedProductForEntry) {
                    document.getElementById('entryProduct').value = selectedProductForEntry.product;
                }
                document.getElementById('entryProductSuggestions').classList.add('hidden');
            }
        });

        const updateTotalExitDisplay = () => {
            const qty1 = Number(document.getElementById('exitQuantity').value) || 0;
            const qty2 = safeCalculate(document.getElementById('exitQuantity2').value || '0');
            document.getElementById('exitTotalDisplay').textContent = qty1 + qty2;
        };
        document.getElementById('exitQuantity').addEventListener('input', updateTotalExitDisplay);
        document.getElementById('exitQuantity2').addEventListener('input', updateTotalExitDisplay);

        document.getElementById('confirmAcceptBtn').addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            toggleModal(document.getElementById('confirmModal'), false);
            confirmCallback = null;
        });
        document.getElementById('confirmCancelBtn').addEventListener('click', () => {
            toggleModal(document.getElementById('confirmModal'), false);
            confirmCallback = null;
        });
        
        document.getElementById('upload-csv-input').addEventListener('change', handleFileUpload);
        
        document.getElementById('viewArchivesBtn').addEventListener('click', handleViewArchives);
        document.getElementById('closeArchivesList').addEventListener('click', () => toggleModal(document.getElementById('archivesListModal'), false));
        document.getElementById('closeReportDetailIcon').addEventListener('click', () => toggleModal(document.getElementById('reportDetailModal'), false));
        document.getElementById('closeReportDetailBtn').addEventListener('click', () => toggleModal(document.getElementById('reportDetailModal'), false));

        document.body.addEventListener('click', (e) => {
            const target = e.target.closest('button[data-action]');
            if (!target) return;

            const action = target.dataset.action;
            const id = target.dataset.id;
            
            switch(action) {
                case 'add-stock': openStockModal(); break;
                case 'edit-stock': openStockModal(id); break;
                case 'delete-row':
                    showConfirmModal({
                        title: '¿Eliminar Fila?', message: 'Esta acción es irreversible.',
                        onConfirm: () => deleteDocument(target.dataset.collection, id)
                    });
                    break;
                case 'clear-collection':
                    showConfirmModal({
                        title: `¿Limpiar ${target.dataset.name}?`, message: `Se borrarán todos los registros de ${target.dataset.name}.`,
                        onConfirm: () => clearCollection(target.dataset.collection)
                    });
                    break;
                case 'download-template': downloadCSVTemplate(); break;
                case 'upload-template': document.getElementById('upload-csv-input').click(); break;
                case 'paste-template': toggleModal(document.getElementById('pasteModal'), true); break;
                case 'view-report': handleViewReportDetail(id); break;
                case 'export-report': handleExportReport(); break;
            }
        });

        document.getElementById('goToInventoryBtn').addEventListener('click', () => {
            showLogin();
        });

        document.getElementById('goToAppointmentsBtn').addEventListener('click', () => {
            showNotification({title: "Próximamente", message: "Horus Date estará disponible pronto."});
        });
        document.getElementById('goToMuseIABtn').addEventListener('click', () => {
            showNotification({title: "Próximamente", message: "Muse IA estará disponible pronto."});
        });
        document.getElementById('goToOdiseaIABtn').addEventListener('click', () => {
            showNotification({title: "Próximamente", message: "Odisea IA estará disponible pronto."});
        });

        document.getElementById('backToLandingBtn').addEventListener('click', () => {
            showLanding();
        });
    }
    
    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
        setupAuth();
        setupEventListeners();
    });
</script>

</body>
</html>
